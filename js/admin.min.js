!function(a){"use strict";if(a.inputDependencies({selector:"select.hasdep",disable:!1}),a("#menu-icons-settings-tabs").on("click","a.mi-settings-nav-tab",function(b){b.preventDefault(),b.stopPropagation();var c=a(this).blur(),d=a("#"+c.data("type"));c.parent().addClass("tabs").siblings().removeClass("tabs"),d.removeClass("tabs-panel-inactive").addClass("tabs-panel-active").show().siblings("div.tabs-panel").hide().addClass("tabs-panel-inactive").removeClass("tabs-panel-active")}).find("a.mi-settings-nav-tab").first().trigger("click"),"undefined"!=typeof window.menuIcons&&void 0!==window.menuIcons.iconTypes){window.menuIcons=_.defaults({frame:"",currentItem:{},toggleSelect:function(b){var c=a(b.currentTarget),d=c.closest("div.menu-icons-wrap"),e=d.find("a._select"),f=d.find("a._remove");""!==c.val()?f.show():(e.text(e.data("text")),f.hide())},selectIcon:function(c){c.preventDefault(),c.stopPropagation();var d=a(this),e=b.view.settings.post.id=d.data("id"),f={id:e,title:a("#edit-menu-item-title-"+e).val()};d.closest("div.menu-icons-wrap").find(":input").each(function(b,c){var d=a(c).data("key");f[d]=c.value}),window.menuIcons.currentItem=f,window.menuIcons.frame instanceof b.view.MediaFrame.menuIcons||(window.menuIcons.frame=new b.view.MediaFrame.menuIcons),window.menuIcons.frame.open()},removeIcon:function(b){b.preventDefault(),b.stopPropagation();var c=a(this).data("id");a("#menu-icons-"+c+"-type").val("").trigger("change")}},window.menuIcons);{var b=wp.media;b.model.Attachment}b.model.mi={},b.model.mi.MenuItems=Backbone.Collection.extend({props:new Backbone.Model({item:""}),model:Backbone.Model.extend({defaults:{type:"",group:"all",icon:"",font_size:"1.2",vertical_align:"middle",hide_label:""}})}),b.model.mi.MenuItems.Settings=Backbone.Collection.extend({model:Backbone.Model.extend({defaults:{id:"",label:"",value:"",type:"text"}})}),b.view.miSidebar=b.view.Sidebar.extend({initialize:function(){var a=new b.View({tagName:"h3",priority:-10}),c=new b.View({tagName:"p",className:"_info",priority:1e3});b.view.Sidebar.prototype.initialize.apply(this,arguments),a.$el.text(window.menuIcons.text.preview),this.set("title",a),c.$el.html(window.menuIcons.text.settingsInfo),this.set("info",c)}}),b.view.miSidebar.Settings=b.view.PriorityList.extend({className:"mi-settings attachment-info",prepare:function(){_.each(this.collection.map(this.createField,this),function(a){this.set(a.model.id,a)},this)},createField:function(a){var c=new b.view.miSidebar.Settings.Field({item:this.model,model:a,collection:this.collection});return c}}),b.view.miSidebar.Settings.Field=b.View.extend({tagName:"label",className:"setting",events:{"change :input":"_update"},initialize:function(){b.View.prototype.initialize.apply(this,arguments),this.template=b.template("menu-icons-settings-field-"+this.model.get("type")),this.model.on("change:value",this._updateDeps,this)},prepare:function(){return this.model.toJSON()},_update:function(b){var c=this.options.item,d=a(b.currentTarget),e=d.val(),f=a("#menu-icons-"+c.id+"-"+this.model.id+"._setting");this.model.set("value",e),c.set(this.model.id,e),f.val(e).trigger("change")}}),b.view.miFont=b.View.extend({className:"attachments-browser mi-items-wrap",initialize:function(){this.createToolbar(),this.createLibrary(),this.createSidebar()},createLibrary:function(){this.items=new b.view.miFont.Library({controller:this.controller,collection:this.collection,selection:this.options.selection,type:this.options.type,data:this.options.data}),this.views.add(this.items)},createToolbar:function(){this.toolbar=new b.view.Toolbar({controller:this.controller}),this.views.add(this.toolbar),this.toolbar.set("filters",new b.view.miFont.Filters({controller:this.controller,model:this.collection.props,priority:-80}).render()),this.toolbar.set("search",new b.view.Search({controller:this.controller,model:this.collection.props,priority:60}).render())},createSidebar:function(){var a=this.options,c=a.selection,d=this.sidebar=new b.view.miSidebar({controller:this.controller,type:a.type});this.views.add(d),c.on("selection:single",this.createSingle,this),c.on("selection:unsingle",this.disposeSingle,this),c.single()&&this.createSingle()},createSingle:function(){this.controller.miUpdateItemProps();var a=this.sidebar,c=this.controller,d=c.miGetCurrentItem();a.set("preview",new b.view.miFont.Icon.Preview({controller:this.controller,model:d,type:this.options.type,priority:80})),this.createSettings()},disposeSingle:function(){var a=this.sidebar;this.controller.miUpdateItemProps(),a.unset("preview"),a.unset("settings")},createSettings:function(){var a=this.controller.miGetCurrentItem(),c=this.controller.state().get("settings");c.length&&(_.each(c,function(b){b.value=a.get(b.id)}),this.sidebar.set("settings",new b.view.miSidebar.Settings({controller:this.controller,collection:new b.model.mi.MenuItems.Settings(c),model:a,type:this.options.type,priority:120})))}}),b.view.miFont.Library=b.View.extend({tagName:"ul",className:"attachments mi-items clearfix",initialize:function(){this._viewsByCid={},this.collection.on("reset",this.refresh,this),this.controller.on("open",this.scrollToSelected,this)},render:function(){return this.collection.each(function(a){this.views.add(this.renderItem(a),{at:this.collection.indexOf(a)})},this),this},renderItem:function(a){var c=new b.view.miFont.Icon({controller:this.controller,model:a,collection:this.collection,selection:this.options.selection,type:this.options.type,data:this.options.data});return this._viewsByCid[c.cid]=c},clearItems:function(){_.each(this._viewsByCid,function(a){delete this._viewsByCid[a.cid],a.remove()},this)},refresh:function(){this.clearItems(),this.render()},ready:function(){this.scrollToSelected()},scrollToSelected:function(){var a,b=this.options.selection.single();b&&(a=this.getView(b),a&&!this.isInView(a.$el)&&this.$el.scrollTop(a.$el.offset().top-this.$el.offset().top+this.$el.scrollTop()-parseInt(this.$el.css("paddingTop"))))},getView:function(a){return _.findWhere(this._viewsByCid,{model:a})},isInView:function(b){var c=a(window),d=c.scrollTop(),e=d+c.height(),f=b.offset().top,g=f+b.height();return e>=g&&f>=d}}),b.view.miFont.Filters=b.view.AttachmentFilters.extend({createFilters:function(){this.filters={all:{text:window.menuIcons.text.all,props:{group:"all"}}};var a=this.controller.state().get("data").groups;_.each(a,function(a,b){this.filters[b]={text:a,props:{group:b}}},this)},change:function(){var a=this.filters[this.el.value];a&&this.model.set("group",a.props.group)}}),b.view.miFont.Icon=b.view.Attachment.extend({className:"attachment mi-item",events:{"click .attachment-preview":"toggleSelectionHandler","click a":"preventDefault"},initialize:function(){this.template=b.template("menu-icons-"+this.options.type+"-item"),b.view.Attachment.prototype.initialize.apply(this,arguments)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.updateSelect(),this}}),b.view.miFont.Icon.Preview=b.View.extend({tagName:"p",className:"mi-preview menu-item attachment-info",events:{"click a":"preventDefault"},initialize:function(){b.View.prototype.initialize.apply(this,arguments),this.model.on("change",this.render,this)},render:function(){var a=this.model.toJSON(),c="menu-icons-"+this.options.type+"-preview-";return c+=a.hide_label?"hide_label":a.position,this.template=b.template(c),this.$el.html(this.template(a)),this},preventDefault:function(a){a.preventDefault()}}),b.controller.miFont=b.controller.State.extend({defaults:{id:"mi-font",menu:"default",toolbar:"mi-select",type:"",settings:["hide_label","position","font_size","vertical_align"]},initialize:function(){var c,d=this.get("data").items,e=this.get("library"),f=this.get("selection"),g=this.get("settings");e instanceof b.controller.miFont.Library||(e=new b.controller.miFont.Library(d),e.props.on("change",this.miResetLibrary,this),this.set("library",e)),f instanceof b.model.Selection||this.set("selection",new b.model.Selection(f,{multiple:!1})),c=_.filter(window.menuIcons.settingsFields,function(b){return-1!==a.inArray(b.id,g)}),this.set("settings",c)},activate:function(){this.frame.on("open",this.refresh,this),this.miUpdateSelection()},deactivate:function(){b.controller.State.prototype.deactivate.apply(this,arguments),this.frame.off("open",this.refresh,this)},refresh:function(){var a=this.get("library"),b=this.frame.miGetCurrentItem(),c=this.get("data").groups,d=b.get("group");_.isUndefined(c[d])&&(d="all"),a.props.set("group",d),this.miUpdateSelection()},miResetLibrary:function(){var a=this.get("library"),b=a.props.get("group"),c=this.frame.miGetCurrentItem();c.set("group",b),a.reInitialize(),this.set("library",a),this.miUpdateSelection()},miUpdateSelection:function(){var a,b=this.get("selection"),c=this.get("type"),d=c+"-icon",e=this.frame.miGetCurrentItem(),f=e.get(d);c===e.get("type")&&f&&(a=this.get("library").findWhere({id:f})),b.reset(a?a:[])},miGetIcon:function(){var a=this.get("selection").single();return a?a.id:""}}),b.controller.miFont.Library=Backbone.Collection.extend({props:new Backbone.Model({group:"all",search:""}),initialize:function(a){this.icons=new Backbone.Collection(a)},reInitialize:function(){var a=this,b=this.icons.toJSON(),c=this.props.toJSON();_.each(c,function(c,d){a.filters[d]&&(b=_.filter(b,a.filters[d],c))},this),this.reset(b)},filters:{group:function(a){var b=this;return"all"===b||a.group===b||""===a.group},search:function(a){var b,c=this;return b=""===c?!0:_.any(["id","label"],function(b){var c=a[b];return c&&-1!==c.search(this)},c)}}}),b.view.MediaFrame.menuIcons=b.view.MediaFrame.extend({initialize:function(){b.view.MediaFrame.prototype.initialize.apply(this,arguments),_.defaults(this.options,{selection:[],multiple:!1,editing:!1,toolbar:"mi-select"}),this.miMenuItems=new b.model.mi.MenuItems,this.createStates(),this.bindHandlers()},createStates:function(){var a,c=this.options;c.states||_.each(window.menuIcons.iconTypes,function(d,e){return b.controller.hasOwnProperty(d.data.controller)?(a=b.controller[d.data.controller],_.defaults(d,{content:d.id,selection:c.selection}),void this.states.add(new a(d))):void delete window.menuIcons.iconTypes[e]},this)},bindHandlers:function(){this.on("toolbar:create:mi-select",this.createToolbar,this),this.on("toolbar:render:mi-select",this.miSelectToolbar,this),this.on("open",this.miInitialize,this),_.each(window.menuIcons.iconTypes,function(a){this.on("content:activate:"+a.id,this.miContentRender,this,a)},this)},miSelectToolbar:function(a){{var b=this,c=b.state();c.get("type")}a.set(c.id,{style:"primary",priority:80,text:window.menuIcons.text.select,requires:{selection:!0},click:function(){b.close(),b.miUpdateItem()}})},miContentRender:function(){var a=this.state(),c=b.view[a.get("data").controller];this.content.set(new c({controller:this,model:a,collection:a.get("library"),selection:a.get("selection"),type:a.get("type")}))},miGetState:function(){var a,b=window.menuIcons.currentItem;return a=!_.isUndefined(b.type)&&""!==b.type&&window.menuIcons.iconTypes.hasOwnProperty(b.type)?b.type:window.menuIcons.typeNames[0],"mi-"+a},miGetCurrentItem:function(){return this.miMenuItems.get(window.menuIcons.currentItem.id)},miUpdateMenuItems:function(){var a=this.miGetCurrentItem();_.isUndefined(a)?this.miMenuItems.add(window.menuIcons.currentItem):a.set(window.menuIcons.currentItem),this.miMenuItems.props.set("item",window.menuIcons.currentItem.id)},miInitialize:function(){this.miUpdateMenuItems(),this.setState(this.miGetState())},miUpdateItemProps:function(){var a=this.state(),b=a.get("type"),c=a.get("selection"),d=c.single(),e=this.miGetCurrentItem(),f=d?d.id:"";e.set("type",b),e.set(b+"-icon",f),e.set("icon",a.miGetIcon())},miUpdateItem:function(){var c,d=this.miGetCurrentItem().toJSON(),e=d.id,f=b.template("menu-icons-"+d.type+"-field");delete d.id,delete d.title,_.each(d,function(b,d){c=a("#menu-icons-"+e+"-"+d).not("._setting"),c.length&&c.val(b).trigger("change")}),a("#menu-icons-"+e+"-select").html(f(d))}}),a("body").on("click","div.menu-icons-wrap a._select",window.menuIcons.selectIcon).on("click","div.menu-icons-wrap a._remove",window.menuIcons.removeIcon).on("change","div.menu-icons-wrap select._type",window.menuIcons.toggleSelect),a("div.menu-icons-wrap select._type").trigger("change")}}(jQuery);